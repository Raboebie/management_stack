services:
  # ── Traefik (reverse proxy + TLS) ────────────────────────────────────────
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - label:disable
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network={{ stack_network }}"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.http.tls=true"
      - "--providers.file.filename=/certs/traefik-tls.yml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:z,ro
      - ./certs:/certs:z,ro
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.home`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.service=api@internal"

  # ── InfluxDB 2.x ─────────────────────────────────────────────────────────
  influxdb:
    image: influxdb:2
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "{{ influxdb_port }}:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: "{{ influxdb_admin_user }}"
      DOCKER_INFLUXDB_INIT_PASSWORD: "{{ influxdb_admin_password }}"
      DOCKER_INFLUXDB_INIT_ORG: "{{ influxdb_org }}"
      DOCKER_INFLUXDB_INIT_BUCKET: "{{ influxdb_bucket }}"
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: "{{ influxdb_admin_token }}"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.influxdb.rule=Host(`influxdb.home`)"
      - "traefik.http.routers.influxdb.entrypoints=websecure"
      - "traefik.http.routers.influxdb.tls=true"
      - "traefik.http.services.influxdb.loadbalancer.server.port=8086"

  # ── Grafana ──────────────────────────────────────────────────────────────
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "{{ grafana_port }}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: "{{ grafana_admin_user }}"
      GF_SECURITY_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:z,ro
    depends_on:
      - influxdb
      - loki
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.home`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # ── Telegraf ─────────────────────────────────────────────────────────────
  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    privileged: true
    pid: host
    network_mode: host
    entrypoint: ["telegraf"]
    security_opt:
      - label:disable
    environment:
      HOST_PROC: /hostfs/proc
      HOST_SYS: /hostfs/sys
      HOST_ETC: /hostfs/etc
      HOST_RUN: /hostfs/run
      HOST_MOUNT_PREFIX: /hostfs
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./telegraf/rocm-smi-telegraf.sh:/usr/local/bin/rocm-smi-telegraf.sh:ro
      - ./telegraf/ollama-metrics.sh:/usr/local/bin/ollama-metrics.sh:ro
      - /proc:/hostfs/proc:ro
      - /sys:/hostfs/sys:ro
      - /etc:/hostfs/etc:ro
      - /run:/hostfs/run:ro
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri

  # ── PostgreSQL (IcingaWeb2 + IcingaDB backend) ──────────────────────────
  postgres:
    image: postgres:16
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      POSTGRES_DB: "{{ postgres_db }}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - {{ stack_network }}

  # ── Redis (IcingaDB state backend) ──────────────────────────────────────
  icingadb-redis:
    image: redis:7
    container_name: icingadb-redis
    restart: unless-stopped
    networks:
      - {{ stack_network }}

  # ── Icinga2 ──────────────────────────────────────────────────────────────
  icinga2:
    image: icinga/icinga2:latest
    container_name: icinga2
    restart: unless-stopped
    ports:
      - "{{ icinga2_api_port }}:5665"
    environment:
      ICINGA_MASTER: 1
      ICINGA_CN: icinga2-master
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - icinga2-data:/data
    depends_on:
      - influxdb
      - icingadb-redis
    networks:
      - {{ stack_network }}

  # ── IcingaDB ─────────────────────────────────────────────────────────────
  icingadb:
    image: icinga/icingadb:latest
    container_name: icingadb
    restart: unless-stopped
    environment:
      ICINGADB_REDIS_HOST: icingadb-redis
      ICINGADB_REDIS_PORT: "6379"
      ICINGADB_DATABASE_HOST: postgres
      ICINGADB_DATABASE_PORT: "5432"
      ICINGADB_DATABASE_DATABASE: "{{ postgres_db }}"
      ICINGADB_DATABASE_USER: "{{ postgres_user }}"
      ICINGADB_DATABASE_PASSWORD: "{{ postgres_password }}"
      ICINGADB_DATABASE_TYPE: pgsql
    depends_on:
      - icinga2
      - icingadb-redis
      - postgres
    networks:
      - {{ stack_network }}

  # ── IcingaWeb2 ───────────────────────────────────────────────────────────
  icingaweb2:
    image: icinga/icingaweb2:latest
    container_name: icingaweb2
    restart: unless-stopped
    ports:
      - "{{ icingaweb2_port }}:8080"
    environment:
      icingaweb.enabledModules: icingadb
      icingaweb.passwords.icingaweb2.icingaadmin: "{{ icingaweb2_admin_password }}"
      icingaweb.authentication.icingaweb2.backend: db
      icingaweb.authentication.icingaweb2.resource: icingaweb_db
      icingaweb.config.logging.log: php
      icingaweb.groups.icingaweb2.backend: db
      icingaweb.groups.icingaweb2.resource: icingaweb_db
      icingaweb.roles.Administrators.users: icingaadmin
      icingaweb.roles.Administrators.permissions: "*"
      icingaweb.resources.icingaweb_db.type: db
      icingaweb.resources.icingaweb_db.db: pgsql
      icingaweb.resources.icingaweb_db.host: postgres
      icingaweb.resources.icingaweb_db.port: "5432"
      icingaweb.resources.icingaweb_db.dbname: "{{ postgres_db }}"
      icingaweb.resources.icingaweb_db.username: "{{ postgres_user }}"
      icingaweb.resources.icingaweb_db.password: "{{ postgres_password }}"
      icingaweb.modules.icingadb.config.icingadb.resource: icingadb
      icingaweb.modules.icingadb.redis.redis1.host: icingadb-redis
      icingaweb.modules.icingadb.redis.redis1.port: "6379"
      icingaweb.modules.icingadb.commandtransports.icinga2.transport: api
      icingaweb.modules.icingadb.commandtransports.icinga2.host: icinga2
      icingaweb.modules.icingadb.commandtransports.icinga2.port: "5665"
      icingaweb.modules.icingadb.commandtransports.icinga2.username: "{{ icinga2_api_user }}"
      icingaweb.modules.icingadb.commandtransports.icinga2.password: "{{ icinga2_api_password }}"
      icingaweb.resources.icingadb.type: db
      icingaweb.resources.icingadb.db: pgsql
      icingaweb.resources.icingadb.host: postgres
      icingaweb.resources.icingadb.port: "5432"
      icingaweb.resources.icingadb.dbname: "{{ postgres_db }}"
      icingaweb.resources.icingadb.username: "{{ postgres_user }}"
      icingaweb.resources.icingadb.password: "{{ postgres_password }}"
    depends_on:
      - icinga2
      - icingadb
      - postgres
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.icingaweb2.rule=Host(`icinga.home`)"
      - "traefik.http.routers.icingaweb2.entrypoints=websecure"
      - "traefik.http.routers.icingaweb2.tls=true"
      - "traefik.http.services.icingaweb2.loadbalancer.server.port=8080"

  # ── Loki (log aggregation) ──────────────────────────────────────────────
  loki:
    image: grafana/loki:3.4
    container_name: loki
    restart: unless-stopped
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki/local-config.yaml:/etc/loki/local-config.yaml:z,ro
      - loki-data:/loki
    networks:
      - {{ stack_network }}

  # ── Promtail (log collector) ────────────────────────────────────────────
  promtail:
    image: grafana/promtail:3.4
    container_name: promtail
    restart: unless-stopped
    user: root
    security_opt:
      - label:disable
    command: -config.file=/etc/promtail/config.yaml
    volumes:
      - ./promtail/config.yaml:/etc/promtail/config.yaml:z,ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log/journal:/var/log/journal:ro
      - /run/log/journal:/run/log/journal:ro
      - /etc/machine-id:/etc/machine-id:ro
      - promtail-positions:/tmp
    depends_on:
      - loki
    networks:
      - {{ stack_network }}

  # ── Portainer (Docker management UI) ────────────────────────────────────
  portainer:
    image: portainer/portainer-ce:lts
    container_name: portainer
    restart: unless-stopped
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:z
      - portainer-data:/data
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.home`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # ── Semaphore (Ansible web UI) ──────────────────────────────────────────
  semaphore:
    image: semaphoreui/semaphore:latest
    container_name: semaphore
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      SEMAPHORE_DB_DIALECT: bolt
      SEMAPHORE_ADMIN: "{{ semaphore_admin_user }}"
      SEMAPHORE_ADMIN_PASSWORD: "{{ semaphore_admin_password }}"
      SEMAPHORE_ADMIN_NAME: "Admin"
      SEMAPHORE_ADMIN_EMAIL: "admin@localhost"
      SEMAPHORE_ACCESS_KEY_ENCRYPTION: "{{ semaphore_access_key }}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - semaphore-data:/var/lib/semaphore
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.semaphore.rule=Host(`semaphore.home`)"
      - "traefik.http.routers.semaphore.entrypoints=websecure"
      - "traefik.http.routers.semaphore.tls=true"
      - "traefik.http.services.semaphore.loadbalancer.server.port=3000"

  # ── Ollama (LLM serving with AMD GPU) ────────────────────────────────────
  ollama:
    image: ollama/ollama:rocm
    container_name: ollama
    restart: unless-stopped
    ports:
      - "{{ ollama_port }}:11434"
    dns:
      - 192.168.88.1
      - 208.67.222.222
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    security_opt:
      - label:disable
    environment:
      HSA_OVERRIDE_GFX_VERSION: "{{ hsa_override_gfx_version }}"
      OLLAMA_HOST: "0.0.0.0:11434"
      OLLAMA_KEEP_ALIVE: "{{ ollama_keep_alive }}"
      OLLAMA_NUM_PARALLEL: "{{ ollama_num_parallel }}"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.home`)"
      - "traefik.http.routers.ollama.entrypoints=websecure"
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"

  # ── Open WebUI (LLM chat interface) ───────────────────────────────────────
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "{{ open_webui_port }}:8080"
    environment:
      OLLAMA_BASE_URL: "http://ollama:11434"
      WEBUI_AUTH: "true"
      WEBUI_SECRET_KEY: "{{ open_webui_secret_key }}"
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      - ollama
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.open-webui.rule=Host(`chat.home`)"
      - "traefik.http.routers.open-webui.entrypoints=websecure"
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"

  # ── Tabby (code completion server) ────────────────────────────────────────
  tabby:
    image: tabbyml/tabby:latest
    container_name: tabby
    restart: unless-stopped
    ports:
      - "{{ tabby_port }}:8080"
    dns:
      - 192.168.88.1
      - 208.67.222.222
    command: serve
    volumes:
      - tabby-data:/data
      - ./tabby/config.toml:/data/config.toml:z,ro
    depends_on:
      - ollama
    networks:
      - {{ stack_network }}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tabby.rule=Host(`tabby.home`)"
      - "traefik.http.routers.tabby.entrypoints=websecure"
      - "traefik.http.routers.tabby.tls=true"
      - "traefik.http.services.tabby.loadbalancer.server.port=8080"

volumes:
  influxdb-data:
  grafana-data:
  postgres-data:
  icinga2-data:
  loki-data:
  promtail-positions:
  portainer-data:
  semaphore-data:
  ollama-data:
  open-webui-data:
  tabby-data:

networks:
  {{ stack_network }}:
    driver: bridge
