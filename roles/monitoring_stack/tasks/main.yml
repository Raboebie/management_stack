---
- name: Create stack directory
  ansible.builtin.file:
    path: "{{ stack_dir }}"
    state: directory
    mode: "0755"

# ── Config directories ───────────────────────────────────────────────────────

- name: Create Telegraf config directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/telegraf"
    state: directory
    mode: "0755"

- name: Create Icinga2 config directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/icinga2/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf.d
    - features-enabled

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - datasources
    - dashboards

- name: Create Grafana dashboards directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/grafana/dashboards"
    state: directory
    mode: "0755"

# ── Templates ────────────────────────────────────────────────────────────────

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ stack_dir }}/docker-compose.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Telegraf config
  ansible.builtin.template:
    src: telegraf.conf.j2
    dest: "{{ stack_dir }}/telegraf/telegraf.conf"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy rocm-smi wrapper script
  ansible.builtin.template:
    src: rocm-smi-telegraf.sh.j2
    dest: "{{ stack_dir }}/telegraf/rocm-smi-telegraf.sh"
    mode: "0755"
  notify: Restart monitoring stack

- name: Deploy Icinga2 constants.conf
  ansible.builtin.template:
    src: icinga2/constants.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/constants.conf"
    mode: "0644"
  register: icinga2_constants

- name: Deploy Icinga2 InfluxDB2 writer feature
  ansible.builtin.template:
    src: icinga2/features/influxdb2.conf.j2
    dest: "{{ stack_dir }}/icinga2/features-enabled/influxdb2.conf"
    mode: "0644"
  register: icinga2_influxdb2

- name: Deploy Icinga2 IcingaDB feature
  ansible.builtin.template:
    src: icinga2/features/icingadb.conf.j2
    dest: "{{ stack_dir }}/icinga2/features-enabled/icingadb.conf"
    mode: "0644"
  register: icinga2_icingadb

- name: Deploy Grafana datasource provisioning
  ansible.builtin.template:
    src: grafana/provisioning/datasources/influxdb.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/datasources/influxdb.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana dashboard provider
  ansible.builtin.template:
    src: grafana/provisioning/dashboards/provider.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/dashboards/provider.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana system monitoring dashboard
  ansible.builtin.copy:
    src: grafana/dashboards/system-monitoring.json
    dest: "{{ stack_dir }}/grafana/dashboards/system-monitoring.json"
    mode: "0644"
  notify: Restart monitoring stack

# ── Start the stack ──────────────────────────────────────────────────────────

- name: Start monitoring stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ stack_dir }}"
  register: compose_up
  changed_when: "'Started' in compose_up.stderr or 'Created' in compose_up.stderr"

# ── Icinga2 post-start config (docker cp into running container) ─────────────

- name: Wait for Icinga2 container to initialize
  ansible.builtin.command:
    cmd: docker exec icinga2 test -f /data/etc/icinga2/icinga2.conf
  register: icinga2_init
  retries: 15
  delay: 3
  until: icinga2_init.rc == 0
  changed_when: false

- name: Copy Icinga2 constants.conf into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/conf.d/constants.conf
      icinga2:/data/etc/icinga2/constants.conf
  when: icinga2_constants.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 influxdb2 feature into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/features-enabled/influxdb2.conf
      icinga2:/data/etc/icinga2/features-enabled/influxdb2.conf
  when: icinga2_influxdb2.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 icingadb feature into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/features-enabled/icingadb.conf
      icinga2:/data/etc/icinga2/features-enabled/icingadb.conf
  when: icinga2_icingadb.changed or compose_up.changed
  notify: Restart icinga2
