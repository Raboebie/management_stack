---
- name: Create stack directory
  ansible.builtin.file:
    path: "{{ stack_dir }}"
    state: directory
    mode: "0755"

# ── Config directories ───────────────────────────────────────────────────────

- name: Create Telegraf config directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/telegraf"
    state: directory
    mode: "0755"

- name: Create Icinga2 config directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/icinga2/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf.d
    - features-enabled

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - datasources
    - dashboards

- name: Create Grafana dashboards directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/grafana/dashboards"
    state: directory
    mode: "0755"

# ── Templates ────────────────────────────────────────────────────────────────

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ stack_dir }}/docker-compose.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Telegraf config
  ansible.builtin.template:
    src: telegraf.conf.j2
    dest: "{{ stack_dir }}/telegraf/telegraf.conf"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Icinga2 constants.conf
  ansible.builtin.template:
    src: icinga2/constants.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/constants.conf"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Icinga2 InfluxDB2 writer feature
  ansible.builtin.template:
    src: icinga2/features/influxdb2.conf.j2
    dest: "{{ stack_dir }}/icinga2/features-enabled/influxdb2.conf"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana datasource provisioning
  ansible.builtin.template:
    src: grafana/provisioning/datasources/influxdb.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/datasources/influxdb.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana dashboard provider
  ansible.builtin.template:
    src: grafana/provisioning/dashboards/provider.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/dashboards/provider.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana system monitoring dashboard
  ansible.builtin.copy:
    src: grafana/dashboards/system-monitoring.json
    dest: "{{ stack_dir }}/grafana/dashboards/system-monitoring.json"
    mode: "0644"
  notify: Restart monitoring stack

# ── Start the stack ──────────────────────────────────────────────────────────

- name: Start monitoring stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ stack_dir }}"
  register: compose_up
  changed_when: "'Started' in compose_up.stderr or 'Created' in compose_up.stderr"
