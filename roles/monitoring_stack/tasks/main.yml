---
- name: Create stack directory
  ansible.builtin.file:
    path: "{{ stack_dir }}"
    state: directory
    mode: "0755"

# ── Config directories ───────────────────────────────────────────────────────

- name: Create Telegraf config directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/telegraf"
    state: directory
    mode: "0755"

- name: Create Icinga2 config directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/icinga2/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf.d
    - features-enabled

- name: Create Grafana provisioning directories
  ansible.builtin.file:
    path: "{{ stack_dir }}/grafana/provisioning/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - datasources

- name: Create Loki config directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/loki"
    state: directory
    mode: "0755"

- name: Create Promtail config directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/promtail"
    state: directory
    mode: "0755"

- name: Create certs directory
  ansible.builtin.file:
    path: "{{ stack_dir }}/certs"
    state: directory
    mode: "0755"

# ── Templates ────────────────────────────────────────────────────────────────

- name: Deploy docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ stack_dir }}/docker-compose.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Telegraf config
  ansible.builtin.template:
    src: telegraf.conf.j2
    dest: "{{ stack_dir }}/telegraf/telegraf.conf"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy rocm-smi wrapper script
  ansible.builtin.template:
    src: rocm-smi-telegraf.sh.j2
    dest: "{{ stack_dir }}/telegraf/rocm-smi-telegraf.sh"
    mode: "0755"
  notify: Restart monitoring stack

- name: Deploy Icinga2 constants.conf
  ansible.builtin.template:
    src: icinga2/constants.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/constants.conf"
    mode: "0644"
  register: icinga2_constants

- name: Deploy Icinga2 hosts.conf
  ansible.builtin.template:
    src: icinga2/conf.d/hosts.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/hosts.conf"
    mode: "0644"
  register: icinga2_hosts

- name: Deploy Icinga2 services.conf
  ansible.builtin.template:
    src: icinga2/conf.d/services.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/services.conf"
    mode: "0644"
  register: icinga2_services

- name: Deploy Icinga2 api-users.conf
  ansible.builtin.template:
    src: icinga2/conf.d/api-users.conf.j2
    dest: "{{ stack_dir }}/icinga2/conf.d/api-users.conf"
    mode: "0644"
  register: icinga2_api_users

- name: Deploy Icinga2 InfluxDB2 writer feature
  ansible.builtin.template:
    src: icinga2/features/influxdb2.conf.j2
    dest: "{{ stack_dir }}/icinga2/features-enabled/influxdb2.conf"
    mode: "0644"
  register: icinga2_influxdb2

- name: Deploy Icinga2 IcingaDB feature
  ansible.builtin.template:
    src: icinga2/features/icingadb.conf.j2
    dest: "{{ stack_dir }}/icinga2/features-enabled/icingadb.conf"
    mode: "0644"
  register: icinga2_icingadb

- name: Deploy Grafana datasource provisioning
  ansible.builtin.template:
    src: grafana/provisioning/datasources/influxdb.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/datasources/influxdb.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Grafana Loki datasource provisioning
  ansible.builtin.template:
    src: grafana/provisioning/datasources/loki.yml.j2
    dest: "{{ stack_dir }}/grafana/provisioning/datasources/loki.yml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Loki config
  ansible.builtin.template:
    src: loki/local-config.yaml.j2
    dest: "{{ stack_dir }}/loki/local-config.yaml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Promtail config
  ansible.builtin.template:
    src: promtail/config.yaml.j2
    dest: "{{ stack_dir }}/promtail/config.yaml"
    mode: "0644"
  notify: Restart monitoring stack

- name: Deploy Traefik TLS config
  ansible.builtin.template:
    src: traefik/tls.yml.j2
    dest: "{{ stack_dir }}/certs/traefik-tls.yml"
    mode: "0644"
  notify: Restart monitoring stack

# ── TLS certificate generation ───────────────────────────────────────────────

- name: Generate TLS certificate with mkcert
  ansible.builtin.command:
    cmd: >-
      mkcert
      -cert-file {{ stack_dir }}/certs/_wildcard.home.pem
      -key-file {{ stack_dir }}/certs/_wildcard.home-key.pem
      "*.home"
      {% for record in pihole_dns_records %}
      {{ record.hostname }}.{{ dns_domain }}
      {% endfor %}
    creates: "{{ stack_dir }}/certs/_wildcard.home.pem"

# ── Start the stack ──────────────────────────────────────────────────────────

- name: Start monitoring stack
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ stack_dir }}"
  register: compose_up
  changed_when: "'Started' in compose_up.stderr or 'Created' in compose_up.stderr"

# ── Icinga2 post-start config (docker cp into running container) ─────────────

- name: Wait for Icinga2 container to initialize
  ansible.builtin.command:
    cmd: docker exec icinga2 test -f /data/etc/icinga2/icinga2.conf
  register: icinga2_init
  retries: 15
  delay: 3
  until: icinga2_init.rc == 0
  changed_when: false

- name: Copy Icinga2 constants.conf into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/conf.d/constants.conf
      icinga2:/data/etc/icinga2/constants.conf
  when: icinga2_constants.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 influxdb2 feature into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/features-enabled/influxdb2.conf
      icinga2:/data/etc/icinga2/features-enabled/influxdb2.conf
  when: icinga2_influxdb2.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 icingadb feature into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/features-enabled/icingadb.conf
      icinga2:/data/etc/icinga2/features-enabled/icingadb.conf
  when: icinga2_icingadb.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 hosts.conf into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/conf.d/hosts.conf
      icinga2:/data/etc/icinga2/conf.d/hosts.conf
  when: icinga2_hosts.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 services.conf into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/conf.d/services.conf
      icinga2:/data/etc/icinga2/conf.d/services.conf
  when: icinga2_services.changed or compose_up.changed
  notify: Restart icinga2

- name: Copy Icinga2 api-users.conf into container
  ansible.builtin.command:
    cmd: >-
      docker cp
      {{ stack_dir }}/icinga2/conf.d/api-users.conf
      icinga2:/data/etc/icinga2/conf.d/api-users.conf
  when: icinga2_api_users.changed or compose_up.changed
  notify: Restart icinga2

# ── Grafana dashboard provisioning via API ───────────────────────────────────

- name: Wait for Grafana API to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ grafana_port }}/api/health"
    method: GET
    status_code: 200
  register: grafana_health
  retries: 20
  delay: 3
  until: grafana_health.status == 200

- name: Get InfluxDB datasource UID from Grafana
  ansible.builtin.uri:
    url: "http://localhost:{{ grafana_port }}/api/datasources/name/InfluxDB"
    method: GET
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: true
    status_code: 200
  register: grafana_datasource
  retries: 10
  delay: 3
  until: grafana_datasource.status == 200

- name: Read dashboard JSON file
  ansible.builtin.slurp:
    src: "{{ role_path }}/files/grafana/dashboards/system-monitoring.json"
  register: dashboard_json_raw

- name: Deploy Grafana dashboard via API
  ansible.builtin.uri:
    url: "http://localhost:{{ grafana_port }}/api/dashboards/db"
    method: POST
    user: "{{ grafana_admin_user }}"
    password: "{{ grafana_admin_password }}"
    force_basic_auth: true
    headers:
      Content-Type: application/json
    body_format: json
    body: >-
      {
        "dashboard": {{ dashboard_json_raw.content | b64decode | regex_replace('"uid":\s*""', '"uid": "' + grafana_datasource.json.uid + '"') }},
        "overwrite": true,
        "message": "Deployed by Ansible"
      }
    status_code:
      - 200
  register: grafana_dashboard_result
  changed_when: true
